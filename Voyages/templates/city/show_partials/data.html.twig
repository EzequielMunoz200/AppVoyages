{% if is_granted('IS_AUTHENTICATED_FULLY') %}
{% set isLiked = false %}
{% for cityLiked in app.user.cityLikes %}
{% dump(cityLiked) %}
{% if cityLiked.city.id ==  objectCity.id %}
{% set isLiked = true %}
{% endif %}
{% endfor %}

{# FULL => fas | EMPTY => far#}
<a class="city-like" href="" data-cityid="{{ objectCity.id }}">
    {% if isLiked == true %}
    <i class="fas fa-heart"></i>
    {% else %}
    <i class="far fa-heart"></i>
    {% endif %}
</a>
{% endif %}



{% dump(app.user) %}
<h1>{{ cityData['fullname'] }}</h1>

{% if cityData['description'] is not null %}
<div id="description">{{ cityData['description']|raw }}</div>
{% else %}
<div class="alert alert-warning text-center p-2">Pas de description pour cette ville</div>
{% endif %}

{{ include('/city/show_partials/tags.html.twig') }}

<div id="city-scores">
    <h3 class="subtitle-section">Des critéres d'appréciation</h3>
    <div id="container-cards">
        {% set iconScore = { 
            0 : 'fas fa-building',
            1 : 'fas fa-hand-holding-usd',
            3 : 'fas fa-piggy-bank',
            4 : 'fas fa-bus-alt', 
            7 : 'fas fa-user-shield', 
            8 : 'fas fa-hand-holding-medical', 
            9 : 'fas fa-user-graduate', 
            10 : 'fas fa-hand-holding-water', 
            11 : 'far fa-money-bill-alt', 
            13 : 'fas fa-wifi', 
            14 : 'fas fa-theater-masks', 
            15 : 'fas fa-genderless',
            16 : 'fas fa-campground' 
        } %}
        {% set categoryScores = { 0 :'Logement'  , 1 : 'Coût de la vie' , 3 : 'Capital risque', 4 : 'Transports', 7 : 'Sécurité', 8 : 'Soins de santé', 9 : 'Éducation', 10 : 'Qualité de l\'environnement', 11 : 'Économie', 13 : 'Accès internet', 14 : 'Loisirs et Culture', 15 : 'Tolérance', 16 : 'En plein air' } %}

        {% if cityData['scores'] is not null %}
        {% for key, score in categoryScores %}
        <div class="card shadow" data-category="{{ score }}"
            data-originalcategory="{{ cityData['scores'][key].name|default('n/a') }}" style="width: 10rem;">
            <i class="{{ iconScore[key]|default('fas fa-exclamation') ~ ' fa-4x' }}"
                style="color: {{ cityData['scores'][key].color|default('n/a') }};"></i>
            <p class="card-text">{{ score|default('n/a') }}</p>
            <p id="p-score" class="card-text">
                {{ cityData['scores'][key].score_out_of_10|number_format(1, '.', ',') ~ ' / 10' }}</p>
        </div>
        {% endfor %}
        {% else %}
        <div class="alert alert-warning text-center p-2">On a pas encore des données pour cette ville</div>
        {% endif %}
    </div>
</div>



<script>

    
    if( document.querySelector('.city-like') !== null ){
        let likeElt = document.querySelector('.city-like');
        let cityId = likeElt.dataset.cityid;
        likeElt.addEventListener('click', changeHeart);
        function changeHeart(evt) {
            evt.preventDefault();
            let url = '/api/v1/city/' + cityId + '/like';
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            })
                .then(
                    (response) => {
                        return response.ok ?
                            (
                                console.log(response.status + ' - opération effectué'),
                                response.json()
                            )
    
                            :
                            (response.status == 204) ? response.status + ' - pas de resultats'
                                :
                                console.log('L\'opération a échoué')
                    })
                .then(
                    (data) => {
                        if (data.code == 200) {
                            likeElt.innerHTML = '';
                            likeElt.innerHTML = '<i class="far fa-heart"></i>';
                        } else if (data.code == 201) {
                            likeElt.innerHTML = '';
                            likeElt.innerHTML = '<i class="fas fa-heart"></i>';
                        }
                    }
                );
        }
    
    }
    
</script>